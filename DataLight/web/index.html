<!DOCTYPE html>
<html>
<head>
<title>Facebook Login</title>
<meta charset="UTF-8">
<link rel="stylesheet" href="styles.css">
<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.0/jquery.min.js"></script>
<script src="script.js"></script>
</head>
<body>
<h1>Welcome to DataLight</h1>
<script>
	$(document).ready(function() {
		$.ajaxSetup({ cache: true});
		$.getScript('//connect.facebook.net/en_US/sdk.js', function() {
  			FB.init({
    			appId      : '453093795064853',
    			cookie     : true,  // enable cookies to allow the server to access session
			    xfbml      : true,  // parse social plugins on this page
			    version    : 'v2.8' // use graph api version 2.8
			  });
		
            FB.getLoginStatus(function(response) {
            	statusChangeCallback(response);
            });
	    });
    });
			
  // This is called with the results from from FB.getLoginStatus().
function statusChangeCallback(response) {
	console.log('statusChangeCallback');
	console.log(response);
    if (response.status === 'connected') {
      	getInfoAPI(testAPI);
    } else {
      // The person is not logged into your app or we are unable to tell.
      	document.getElementById('status').innerHTML = 'Please log ' +
        'into this app.';
    }
}

function checkLoginState() {
	FB.getLoginStatus(function(response) {
	statusChangeCallback(response);
    });
}

  function getInfoAPI(testAPI) {
    console.log('Welcome!  Fetching your information.... ');
    FB.api('/me', 'get', function(response) {
	    var userId = response.id;
        console.log('Successful login for: ' + response.name);
        document.getElementById('status').innerHTML =
        'Thanks for logging in, ' + response.name + '!';
        testAPI(userId);
    });
    
}

var allLikes = []; 
// retrieve all user's likes
function getAllLikes(response) {
    // likes is an arry of size 100 objects
    var likes = response.data;
    for (i in likes) {
        allLikes.push(likes[i].name);
    }
    
    var nextPage = response.paging.next;
	console.log('Printing before getJSON: ' + nextPage);

    if (nextPage) {
        $.getJSON(nextPage, function(response) {
			console.log('Printing after getJSON: ' + nextPage);
            getAllLikes(response);
        });
    }
}

var allPosts = [];
function getAllPosts(response) {
    // posts is an arry of size 100 objects
    var posts = response.data;
    for (i in posts) {
        if(posts[i].message) {  
            allPosts.push(posts[i].message);
        } 
    }
    
    var nextPage = response.paging.next;
	console.log('Post Printing before getJSON: ' + nextPage);
    if (nextPage != undefined) {
        $.getJSON(nextPage, function(response) {
			console.log('Posts Printing after getJSON: ' + nextPage);
            getAllPosts(response);
        });
    }
}

function testAPI(userId) {
    FB.api('/'+userId+'/likes', 'get', function(response) {
        getAllLikes(response);
        //console.log(allLikes);
    }); 

    FB.api('/'+userId+'/posts', 'get', function(response) {
        getAllPosts(response);
        console.log(allPosts);
    });

}

function logout() {
    console.log('printing test');
	FB.logout(function(response) {
		console.log("You successfully logout");
		checkLoginState();
	});

}

</script>

<div class="fb-login-button" 
	data-max-rows="1" 
	data-size="large" 
	data-button-type="login_with" 
	data-show-faces="false" 
	data-auto-logout-link="false" 
	data-use-continue-as="false" 
	data-scope = "public_profile, email, user_posts, user_likes" 
	onlogin="checkLoginState()"></div>

<div id="logout">
	<button type="button" onclick="logout()">Log out</button>
</div>

<div id="status">
</div>

</body>
</html>
